<%- include('partials/header') %>

<div class="breadcrumb">
  <a href="/">Home</a> &raquo;
  <% if (product.category_slug) { %>
    <a href="/shop?category=<%= product.category_slug %>"><%= product.category_name %></a> &raquo;
  <% } %>
  <span><%= product.name %></span>
</div>

<div class="product-detail">
  <div class="product-gallery">
    <div class="gallery-main">
      <img id="mainImage" src="<%= images.length > 0 ? images[0].image_url : product.image_url %>" alt="<%= product.name %>">
    </div>
    <% if (images.length > 1) { %>
      <div class="gallery-thumbs">
        <% images.forEach((img, index) => { %>
          <div class="gallery-thumb <%= index === 0 ? 'active' : '' %>" onclick="changeImage('<%= img.image_url %>', this)">
            <img src="<%= img.image_url %>" alt="<%= product.name %>">
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>
  <div class="product-detail-info">
    <span class="product-category"><%= product.category_name || 'Uncategorized' %></span>
    <h1><%= product.name %></h1>

    <div class="rating-summary">
      <div class="stars-display">
        <% for (let i = 1; i <= 5; i++) { %>
          <% if (i <= Math.floor(avgRating)) { %>
            <span class="star filled">&#9733;</span>
          <% } else if (i - avgRating < 1 && i - avgRating > 0) { %>
            <span class="star half">&#9733;</span>
          <% } else { %>
            <span class="star">&#9733;</span>
          <% } %>
        <% } %>
      </div>
      <span class="rating-number"><%= avgRating %></span>
      <span class="rating-count">(<%= totalReviews %> <%= totalReviews === 1 ? 'review' : 'reviews' %>)</span>
      <form action="/product/<%= product.id %>/love" method="POST" class="love-form">
        <button type="submit" class="love-btn <%= customerLoved ? 'loved' : '' %>">
          <span class="love-icon"><% if (customerLoved) { %>&#10084;<% } else { %>&#9825;<% } %></span>
          <span class="love-count"><%= loveCount %></span>
        </button>
      </form>
    </div>

    <p class="product-price large">$<%= parseFloat(product.price).toFixed(2) %></p>
    <p class="product-description"><%= product.description %></p>

    <% const perks = []; 
       if (product.perk_free_delivery) perks.push({ icon: 'ðŸšš', text: product.perk_free_delivery_text || 'Free Delivery on All Orders' });
       if (product.perk_free_returns) perks.push({ icon: 'â†©ï¸', text: product.perk_free_returns_text || 'FREE 15-Day Returns' });
       if (product.perk_buy_now_pay_later) perks.push({ icon: 'ðŸ’³', text: product.perk_buy_now_pay_later_text || 'Buy Now, Pay Later with Tamara & Tabby' });
       if (product.perk_next_day_riyadh) perks.push({ icon: 'âš¡', text: product.perk_next_day_riyadh_text || 'Free Next Day Delivery in Riyadh' });
    %>
    <% if (perks.length > 0) { %>
      <ul class="product-perks">
        <% perks.forEach(perk => { %>
          <li><span class="perk-icon"><%= perk.icon %></span> <%= perk.text %></li>
        <% }) %>
      </ul>
    <% } %>

    <% if (product.stock > 0) { %>
      <p class="stock-info">In Stock: <%= product.stock %> available</p>
      <form action="/cart/add" method="POST" class="add-to-cart-form">
        <input type="hidden" name="productId" value="<%= product.id %>">
        <div class="quantity-selector">
          <label for="quantity">Quantity:</label>
          <input type="number" name="quantity" id="quantity" value="1" min="1" max="<%= product.stock %>">
        </div>
        <button type="submit" class="btn btn-primary btn-large">Add to Cart</button>
      </form>
    <% } else { %>
      <p class="out-of-stock-msg">Currently out of stock</p>
    <% } %>
  </div>
</div>

<section class="reviews-section">
  <h2>Customer Reviews</h2>

  <div class="reviews-overview">
    <div class="reviews-avg">
      <span class="avg-big"><%= avgRating %></span>
      <div>
        <div class="stars-display">
          <% for (let i = 1; i <= 5; i++) { %>
            <% if (i <= Math.floor(avgRating)) { %>
              <span class="star filled">&#9733;</span>
            <% } else if (i - avgRating < 1 && i - avgRating > 0) { %>
              <span class="star half">&#9733;</span>
            <% } else { %>
              <span class="star">&#9733;</span>
            <% } %>
          <% } %>
        </div>
        <span class="rating-count"><%= totalReviews %> <%= totalReviews === 1 ? 'review' : 'reviews' %></span>
      </div>
    </div>
  </div>

  <% if (locals.customerId && !customerReviewed) { %>
    <div class="review-form-container">
      <h3>Write a Review</h3>
      <form action="/product/<%= product.id %>/review" method="POST" class="review-form">
        <div class="form-group">
          <label>Your Rating</label>
          <div class="star-rating-input">
            <% for (let i = 5; i >= 1; i--) { %>
              <input type="radio" name="rating" value="<%= i %>" id="star<%= i %>" <%= i === 5 ? 'checked' : '' %>>
              <label for="star<%= i %>">&#9733;</label>
            <% } %>
          </div>
        </div>
        <div class="form-group">
          <label for="review_text">Your Review</label>
          <textarea name="review_text" id="review_text" rows="4" placeholder="Share your experience with this product..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit Review</button>
      </form>
    </div>
  <% } else if (!locals.customerId) { %>
    <div class="review-login-prompt">
      <p><a href="/auth/login?redirect=/product/<%= product.id %>">Sign in</a> to write a review or love this product.</p>
    </div>
  <% } %>

  <% if (reviews.length > 0) { %>
    <div class="reviews-list">
      <% reviews.forEach(review => { %>
        <div class="review-card">
          <div class="review-header">
            <div class="review-author"><%= review.customer_name %></div>
            <div class="review-date"><%= new Date(review.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></div>
          </div>
          <div class="stars-display review-stars">
            <% for (let i = 1; i <= 5; i++) { %>
              <span class="star <%= i <= review.rating ? 'filled' : '' %>">&#9733;</span>
            <% } %>
          </div>
          <% if (review.review_text) { %>
            <p class="review-text"><%= review.review_text %></p>
          <% } %>
        </div>
      <% }) %>
    </div>
  <% } else { %>
    <p class="no-reviews">No reviews yet. Be the first to review this product!</p>
  <% } %>
</section>

<% if (related.length > 0) { %>
  <section class="related-products">
    <h2>You Might Also Like</h2>
    <div class="product-grid compact">
      <% related.forEach(item => { %>
        <div class="product-card">
          <a href="/product/<%= item.id %>">
            <div class="product-image">
              <img src="<%= item.image_url %>" alt="<%= item.name %>">
            </div>
            <div class="product-info">
              <h3><%= item.name %></h3>
              <p class="product-price">$<%= parseFloat(item.price).toFixed(2) %></p>
            </div>
          </a>
        </div>
      <% }) %>
    </div>
  </section>
<% } %>

<script>
function changeImage(url, thumb) {
  document.getElementById('mainImage').src = url;
  document.querySelectorAll('.gallery-thumb').forEach(t => t.classList.remove('active'));
  thumb.classList.add('active');
}
</script>

<%- include('partials/footer') %>
